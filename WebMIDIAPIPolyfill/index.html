<html>
<head>
<!-- <script type="text/javascript" src="WebMIDIAPIPolyfill.js"></script> -->
<script type="text/javascript">
    var midiAccess = null;

    function setup() {
        if (window.navigator.requestMIDIAccess) {
            window.navigator.requestMIDIAccess().then( success, function() { alert("requestMIDIAccess() failed.") });
        } else {
            alert("Web MIDI API is not available.");
        }

        function success(access) {
            midiAccess = access;

            midiAccess.onconnect = function (event) {
                var str = "midiAccess connect: " + event.port.name;
                var messagelog = document.getElementById('messagelog');
                messagelog.innerHTML += str + "\n";
            }

            midiAccess.ondisconnect = function (event) {
                var str = "midiAccess disconnect: " + event.port.name;
                var messagelog = document.getElementById('messagelog');
                messagelog.innerHTML += str + "\n";
            }

            var inputs = midiAccess.inputs();
            for (var port = 0; port < inputs.length; port++) {
                var str = "input port " + port + ", manufacturer: " + inputs[port].manufacturer + ", name: " + inputs[port].name;
                var messagelog = document.getElementById('messagelog');
                messagelog.innerHTML += str + "\n";

                (function () {
                    var _port = port;
                    inputs[_port].onmidimessage = function (event) {
                        var str = "port:" + _port + ", receivedTime:" + event.receivedTime.toFixed(2) + ", ";
                        for (var i = 0; i < event.data.length; i++) {
                            str += "0x" + event.data[i].toString(16) + " ";
                        }
                    
                        var messagelog = document.getElementById('messagelog');
                        messagelog.innerHTML += str + "\n";
                        messagelog.scrollTop = messagelog.scrollHeight;
                    };
                 
                    inputs[_port].ondisconnect = function (event) {
                        var str = "input port:" + _port + ", disconnected.";
                        var messagelog = document.getElementById('messagelog');
                        messagelog.innerHTML += str + "\n";
                    };
                }());
            }

            var outputs = midiAccess.outputs();
            for (var port = 0; port < outputs.length; port++) {
                (function () {
                    var _port = port;
                    outputs[_port].ondisconnect = function (event) {
                        var str = "output port:" + _port + ", disconnected.";
                        var messagelog = document.getElementById('messagelog');
                        messagelog.innerHTML += str + "\n";
                    };
                }());
            }
        }
    }

    function _midiMessageListener() {
        document.getElementById('messagelog').innerHTML += "event received" + "\n";
    }

    function _inputPortDisconnectListener() {
        document.getElementById('messagelog').innerHTML += "input disconnect event received" + "\n";
    }

    function _outputPortDisconnectListener() {
        document.getElementById('messagelog').innerHTML += "output disconnect event received" + "\n";
    }

    function _midiaccessConnectListener() {
        document.getElementById('messagelog').innerHTML += "midiaccess connect event received" + "\n";
    }

    function _midiaccessDisconnectListener() {
        document.getElementById('messagelog').innerHTML += "midiaccess disconnect event received" + "\n";
    }



    function enableEventListener() {
        var inputs = midiAccess.inputs();
        for (var port = 0; port < inputs.length; port++) {
            inputs[port].addEventListener("midimessage", _midiMessageListener, false);
            inputs[port].addEventListener("disconnect", _inputPortDisconnectListener, false);
        }

        var outputs = midiAccess.outputs();
        for (var port = 0; port < outputs.length; port++) {
            outputs[port].addEventListener("disconnect", _outputPortDisconnectListener, false);
        }
        
        midiAccess.addEventListener("connect", _midiaccessConnectListener, false);
        midiAccess.addEventListener("disconnect", _midiaccessDisconnectListener, false);
    }

    function disableEventListener() {
        var inputs = midiAccess.inputs();
        for (var port = 0; port < inputs.length; port++) {
            inputs[port].removeEventListener("midimessage", _midiMessageListener, false);
            inputs[port].removeEventListener("disconnect", _inputPortDisconnectListener, false);
        }

        var outputs = midiAccess.outputs();
        for (var port = 0; port < outputs.length; port++) {
            outputs[port].removeEventListener("disconnect", _outputPortDisconnectListener, false);
        }
        
        midiAccess.removeEventListener("connect", _midiaccessConnectListener, false);
        midiAccess.removeEventListener("disconnect", _midiaccessDisconnectListener, false);
    }

    function noteOn() {
        var outputs = midiAccess.outputs();
        for (var i = 0; i < outputs.length; i++) {
            var output = outputs[i];
            output.send( [0x90, 60, 0x40] , window.performance.now() );
        }
    }

    function noteOff() {
        var outputs = midiAccess.outputs();
        for (var i = 0; i < outputs.length; i++) {
            var output = outputs[i];
            output.send( [0x80, 60, 0x40] , window.performance.now() );
        }
    }

    window.onload = function() {
        setup();
    }

</script>
</head>
<body>
<h1>Web MIDI API sample</h1>
<a href="javascript:setup();">[setup]</a>
<a href="javascript:noteOn();">[note on]</a>
<a href="javascript:noteOff();">[note off]</a>

<a href="javascript:enableEventListener();">[enableEventListener]</a>
<a href="javascript:disableEventListener();">[disableEventListener]</a>


<h2>MIDI input monitor</h2>
<a href="javascript:document.getElementById('messagelog').innerHTML = '';">[clear log]</a>
<pre id="messagelog" style="width:100%; height:80%; overflow:auto; border:1px solid #aaaaaa;"></pre>
</body>
</html>
